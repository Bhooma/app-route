<script>
  'use strict';

  Polymer.CarbonRoutingBehavior = {

    properties: {
      /**
       * The URL component managed by this element.
       */
      path: {
        type: String,
        notify: true
      },

      /**
       * The pattern to match `path` against.
       * "<literal>|:<named>/..."
       * Path values like `:named` become pseudo-properties of the same name
       * on this element.
       */
      match: {
        type: String
      },

      /**
       * The part of `path` that's consumed by `match`
       */
      matched: {
        type: String,
        notify: true
      },

      /**
       * The part of `path` NOT consumed by `match`.
       * Equivalent to `path.substring(matched.length + 1)`
       */
      rest: {
        notify: true,
        observer: '_restChanged'
      },

    },

    observers: [
      '_tryToMatch(path, match)',
    ],


    created: function() {
      this._dynData = {};
    },

    _computeData: function(path, match) {
      return this._tryToMatch(path, match);
    },

    // TODO: disallow name clashes in match. Allow regex?

    _tryToMatch: function(path, match) {
      var remainingPieces = path.split('/');
      var matchPieces = match.split('/');

      var matched = [];
      var namedMatches = {};

      var clearProperties = function clearProperties() {
        this.matched = this.rest = null;
        for (var i = 0; i < matchPieces.length; i++) {
          var matchPiece = matchPieces[i];
          if (matchPiece.charAt(0) === ':') {
            this[matchPiece.slice(1)] = null;
          }
        }
      }.bind(this);

      for (var i=0; i < matchPieces.length; i++) {
        var matchPiece = matchPieces[i];
        if (!matchPiece && matchPiece !== '') {
          break;
        }
        var pathPiece = remainingPieces.shift();

        // We don't match this path.
        if (!pathPiece && pathPiece !== '') {
          clearProperties();
          return;
        }
        matched.push(pathPiece);

        if (matchPiece.charAt(0) == ':') {
          matchPiece = matchPiece.slice(1);
          namedMatches[matchPiece] = pathPiece;
        } else if (matchPiece !== pathPiece) {
          clearProperties();
          return;
        }
      }

      Object.keys(namedMatches).forEach(function(name) {
        this._fauxNotify(name, namedMatches[name]);
      }, this);

      var matched = matched.join('/');
      var tail = remainingPieces.join('/');

      this.matched = matched;
      this.rest = tail;
    },

    _restChanged: function(rest) {
      if (rest && this.matched) {
        this.path = this.matched + '/' + this.rest;
      }
    },

    _fauxNotify: function(property, value) {
      if (!Object.hasOwnProperty(this, property)) {
        Object.defineProperty(this, property, {
          configurable: true,
          get: function() {
            return this._dynData[property];
          },
          set: function(value) {
            this._dynData[property] = value;
            this._updatePathOnDataChange();

            // TODO(sjmiles): flaw in fauxification:
            // the notification can occur before the parent listener is ready
            // `async` fixes it, but at what cost?
            this.async(function() {
              this._notifyChange(property);
            });
          }
        });
      }

      this[property] = value;
    },

    _updatePathOnDataChange: function() {
      if (!this.matched) {
        return;
      }
      this.path = this.getLink({});
    },

    getLink: function(overrideValues) {
      var values = {rest: this.rest};
      for (var key in this._dynData) {
        values[key] = this._dynData[key];
      }
      for (var key in overrideValues) {
        values[key] = overrideValues[key];
      }
      var matchPieces = this.match.split('/');
      var interp = matchPieces.map(function(value) {
        if (value[0] == ':') {
          value = values[value.slice(1)];
        }
        return value;
      }, this);
      if (values.rest) {
        interp.push(values.rest);
      }
      return interp.join('/');
    }
  };

  Polymer({
    is: 'carbon-route',

    behaviors: [
      Polymer.CarbonRoutingBehavior
    ]
  });
</script>
