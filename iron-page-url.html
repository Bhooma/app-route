<link rel="import" href="../polymer/polymer.html">

<!--

This element manages binding to and from the current URL.

When the URL is: `/search?query=mr%20skeltal#doot` this element will have:
  - path: `/search`
  - params: `{query: 'mr skeltal'}`
  - hash: 'doot'

These bindings are bidirectional, so modifying them will in turn modify the URL.

This element is only active while it is attached to the document.

 -->
<script>
  'use strict';

  Polymer({
    is: 'iron-page-url',
    properties: {
      /**
       * The pathname component of the URL.
       */
      path: {
        type: String,
        notify: true
      },
      /**
       * The GET params of the URL.
       */
      params: {
        type: Object,
        notify: true
      },
      /**
       * The hash component of the URL.
       */
      hash: {
        type: String,
        notify: true
      },
      /**
       * If the user was on a URL for less than `dwellTime` milliseconds, it
       * won't be added to the browser's history, but instead will be replaced
       * by the next entry.
       *
       * This is to prevent large numbers of entries from clogging up the user's
       * browser history. Disable by setting to a negative number.
       */
      dwellTime: {
        type: Number,
        value: 2000
      },
      _lastChangedAtAt: {
        type: Number,
        value: -Infinity
      },
      _dontUpdateUrl: {
        type: Boolean,
        value: false
      }
    },
    observers: [
      '_updateUrl(path, params.*, hash)'
    ],
    attached: function() {
      this.listen(window, 'hashchange', '_hashChanged');
      this.listen(window, 'location-changed', '_urlChanged');
      this.listen(window, 'popstate', '_urlChanged');

      this._urlChanged();
    },
    detached: function() {
      this.unlisten(window, 'hashchange', '_hashChanged');
      this.unlisten(window, 'location-changed', '_urlChanged');
      this.unlisten(window, 'popstate', '_urlChanged');
    },
    _now: function() {
      if (window.performance && window.performance.now) {
        return window.performance.now();
      }
      return +new Date();
    },
    _hashChanged: function() {
      this.hash = window.location.hash.substring(1);
    },
    _urlChanged: function() {
      // We want to extract all info out of the updated URL before we
      // try to write anything back into it.
      //
      // i.e. without _dontUpdateUrl we'd overwrite the new path with the old
      // one when we set this.hash. Likewise for params.
      this._dontUpdateUrl = true;
      this._hashChanged();
      this.path = window.location.pathname;
      this.params = this._decodeParams(window.location.search.substring(1));
      this._dontUpdateUrl = false;
      this._updateUrl();
    },
    _getUrl: function() {
      var url = this.path;
      var params = this._encodeParams(this.params);
      if (params) {
        url += '?' + params;
      }
      if (this.hash) {
        url += '#' + this.hash;
      }
      return url;
    },
    _updateUrl: function() {
      if (this._dontUpdateUrl) {
        return;
      }
      var newUrl = this._getUrl();
      this._lastChangedAt = this._now();
      var currentUrl = (
          window.location.pathname +
          window.location.search +
          window.location.hash
      );
      if (newUrl == currentUrl) {
        // nothing to do, we're on the same page
        return;
      }

      var shouldReplace = (
          this._lastChangedAt + this.dwellTime > this._now());
      if (shouldReplace) {
        window.history.replaceState({}, '', newUrl);
      } else {
        window.history.pushState({}, '', newUrl);
      }
    },
    _encodeParams: function(params) {
      var encodedParams = [];
      for (var key in params) {
        var value = params[key];
        if (value === '') {
          encodedParams.push(encodeURIComponent(key));
        } else if (value) {
          encodedParams.push(
              encodeURIComponent(key) +
              '=' +
              encodeURIComponent(value.toString())
          );
        }
      }
      return encodedParams.join('&');
    },
    _decodeParams: function(paramString) {
      var params = {};
      var paramList = (paramString || '').split('&');
      for (var i = 0; i < paramList.length; i++) {
        var param = paramList[i].split('=');
        if (param[0]) {
          params[decodeURIComponent(param[0])] =
              decodeURIComponent(param[1] || '');
        }
      }
      return params;
    }
  });
</script>
