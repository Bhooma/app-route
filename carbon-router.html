<link rel="import" href="../polymer/polymer.html">

<script>
  'use strict';

  Polymer({
    is: 'carbon-router',
    properties: {
      path: {
        type: String,
        notify: true
      },
      params: {
        type: Object,
        notify: true
      },
      hash: {
        type: String,
        notify: true
      },
      dwellTime: {
        type: Number,
        value: 2000
      },
      _lastChangedAtAt: {
        type: Number,
        value: -Infinity
      },
      _dontUpdateUrl: {
        type: Boolean,
        value: false
      }
    },
    observers: [
      '_updateUrl(path, params.*, hash)'
    ],
    attached: function() {
      this.listen(window, 'hashchange', '_hashChanged');
      this.listen(window, 'location-changed', '_urlChanged');
      this.listen(window, 'popstate', '_urlChanged');

      this._urlChanged();
    },
    detached: function() {
      this.unlisten(window, 'hashchange', '_hashChanged');
      this.unlisten(window, 'location-changed', '_urlChanged');
      this.unlisten(window, 'popstate', '_urlChanged');
    },
    _now: function() {
      if (window.performance && window.performance.now) {
        return window.performance.now();
      }
      return +new Date();
    },
    _hashChanged: function() {
      this.hash = window.location.hash.substring(1);
    },
    _urlChanged: function() {
      // We want to extract all info out of the updated URL before we
      // try to write anything back into it.
      //
      // i.e. without _dontUpdateUrl we'd overwrite the new path with the old
      // one when we set this.hash. Likewise for params.
      this._dontUpdateUrl = true;
      this._hashChanged();
      this.path = window.location.pathname;
      this.params = this._decodeParams(window.location.search.substring(1));
      this._dontUpdateUrl = false;
      this._updateUrl();
    },
    _getUrl: function() {
      var url = this.path;
      var params = this._encodeParams(this.params);
      if (params) {
        url += '?' + params;
      }
      if (this.hash) {
        url += '#' + this.hash;
      }
      return url;
    },
    _updateUrl: function() {
      if (this._dontUpdateUrl) {
        return;
      }
      var newUrl = this._getUrl();
      this._lastChangedAt = this._now();
      var currentUrl = (
          window.location.pathname +
          window.location.search +
          window.location.hash
      );
      if (newUrl == currentUrl) {
        // nothing to do, we're on the same page
        return;
      }

      var shouldReplace = (
          this._lastChangedAt + this.dwellTime > this._now());
      if (shouldReplace) {
        window.history.replaceState({}, '', newUrl);
      } else {
        window.history.pushState({}, '', newUrl);
      }
    },
    _encodeParams: function(params) {
      var paramList = [];
      for (var key in params) {
        var value = params[key];
        if (value === true) {
          paramList.push(encodeURIComponent(key));
        } else if (value && value != '') {
          paramList.push(
              encodeURIComponent(key) + '=' + encodeURIComponent(value + ''));
        }
      }
      return paramList.join('&');
    },
    _decodeParams: function(paramString) {
      var params = {};
      var paramList = (paramString || '').split('&');
      for (var i = 0; i < paramList.length; i++) {
        var param = paramList[i].split('=');
        if (param[0]) {
          params[decodeURIComponent(param[0])] =
              decodeURIComponent(param[1] || '');
        }
      }
      return params;
    }
  });
</script>
