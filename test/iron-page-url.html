<!doctype html>
<!--
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<html>
<head>
  <title>iron-page-url</title>

  <script src="../../webcomponentsjs/webcomponents.js"></script>
  <script src="../../web-component-tester/browser.js"></script>
  <script src="../../test-fixture/test-fixture-mocha.js"></script>

  <link rel="import" href="../../polymer/polymer.html">
  <link rel="import" href="../../promise-polyfill/promise-polyfill.html">
  <link rel="import" href="../../test-fixture/test-fixture.html">
  <link rel="import" href="../iron-page-url.html">
  <link rel="import" href="../carbon-route.html">
  <link rel="import" href="combined-elem.html">
</head>
<body>

<script>
  'use strict';

  function timePasses(ms) {
    return new Promise(function(resolve) {
      window.setTimeout(function() {
        resolve();
      }, ms);
    });
  }

  function tryUntilTrue(f) {
    return new Promise(function(resolve) {
      if (f()) {
        resolve();
      }
      var interval = setInterval(function() {
        if (f()) {
          clearInterval(interval);
          resolve();
        }
      }, 1);
    });
  }

  var originalFlush = flush;
  flush = function() {
    return new Promise(function(resolve) {
      originalFlush(resolve);
    });
  }

  suite('<iron-page-url>', function () {
    var initialUrl;
    setup(function() {
      initialUrl = window.location.href;
    });
    teardown(function(){
      window.history.replaceState({}, '', initialUrl);
    });

    suite('when used solo', function() {
      var urlElem;
      setup(function() {
        urlElem = document.createElement('iron-page-url');
        urlElem.attached();
      });
      teardown(function() {
        urlElem.detached();
      });
      test('basic functionality with #hash urls', function() {
        // Initialized to the window location's hash.
        expect(window.location.hash).to.be.equal(urlElem.hash);

        // Changing the urlElem's hash changes the URL
        urlElem.hash = '/lol/ok';
        expect(window.location.hash).to.be.equal('#/lol/ok');

        // Changing the hash via normal means changes the urlElem.
        var anchor = document.createElement('a');
        anchor.href = '#/wat';
        document.body.appendChild(anchor);
        anchor.click();
        expect(urlElem.hash).to.be.equal('/wat');
      });
      test('basic functionality with paths', function() {
        // Initialized to the window location's path.
        expect(window.location.pathname).to.be.equal(urlElem.path);

        // Changing the urlElem's path changes the URL
        urlElem.path = '/foo/bar';
        expect(window.location.pathname).to.be.equal('/foo/bar');

        // Changing the path and sending a custom event on the window changes
        // the urlElem.
        window.history.replaceState({}, '', '/baz')
        window.dispatchEvent(new CustomEvent('location-changed'));
        expect(urlElem.path).to.be.equal('/baz');
      });
      test('basic functionality with ?key=value params', function() {
        // Initialized to the window location's params.
        expect(urlElem.params).to.deep.eq({});

        // Changing location.search and sending a custom event on the window
        // changes the urlElem.
        window.history.replaceState({}, '', '/?greeting=hello&target=world');
        window.dispatchEvent(new CustomEvent('location-changed'));
        expect(urlElem.params).to.deep.equal(
            {greeting: 'hello', target: 'world'});

        // Changing the urlElem's path changes the URL.
        urlElem.set('params.another', 'key');
        expect(window.location.search).to.be.equal(
            '?greeting=hello&target=world&another=key');
      });
    });

    suite('used with <carbon-route> based on hash', function() {
      var combinedElem;
      var urlElem;
      var route1;
      var route2;
      setup(function() {
        combinedElem = document.createElement('combined-elem');
        document.body.appendChild(combinedElem);
        urlElem = combinedElem.$.pageurl;
        route1 = combinedElem.$.route1;
        route2 = combinedElem.$.route2;
      });
      teardown(function() {
        document.body.removeChild(combinedElem);
      });

      test('route matching works', function() {
        urlElem.hash = '/wat';

        // The matched route's state should be correct
        expect(route1.matched).to.be.equal('/wat');
        expect(route1.rest).to.be.equal('');

        // The unmatched route's state should be null.
        expect(route2.matched).to.be.equal(null);
        expect(route2.rest).to.be.equal(null);
        expect(route2.name).to.be.equal(null);
        expect(route2.action).to.be.equal(null);

        // Modifying the matched route's `rest` param should update the URL.
        route1.rest = 'more/pieces';
        expect(urlElem.hash).to.be.equal('/wat/more/pieces');

        // Modifying the unmatched route's `rest` param should have no effect.
        route2.rest = 'hey whats up';
        expect(urlElem.hash).to.be.equal('/wat/more/pieces');
      });

      test('structured route matching works', function() {
        urlElem.hash = '/user/jane/edit/details';
        // The unmatched route's state should be null.
        expect(route1.path).to.be.equal('/user/jane/edit/details')
        expect(route1.matched).to.be.equal(null);
        expect(route1.rest).to.be.equal(null);

        // The matched structured route's state is correct.
        expect(route2.path).to.be.equal('/user/jane/edit/details')
        expect(route2.matched).to.be.equal('/user/jane/edit');
        expect(route2.rest).to.be.equal('details');
        expect(route2.name).to.be.equal('jane');
        expect(route2.action).to.be.equal('edit');

        // We can change a faux property on the route and the URL changes.
        route2.action = 'view';
        expect(urlElem.hash).to.be.equal('/user/jane/view/details');

        return flush().then(function() {
          expect(combinedElem.name).to.be.equal('jane');
          expect(combinedElem.action).to.be.equal('view');

          // When the route no longer matches, the dynamic properties are nulled
          // out again.
          urlElem.hash = '/nothing_matches_this';
          expect(route2.name).to.be.equal(null);
          expect(route2.action).to.be.equal(null);
        });
      });
    });
  });

</script>
</body>
