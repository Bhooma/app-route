<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-location/iron-location.html">
<link rel="import" href="carbon-route-converter.html">

<!--
`carbon-location` is an element that provides synchronization between the
browser location bar and the state of an app. When created, `carbon-location`
elements will automatically watch the global location for changes. As changes
occur, `carbon-location` produces and updates an object called `route`. This
`route` object is suitable for passing into a `carbon-route`, and other similar
elements.

An example of the public API of a route object that describes the URL
`https://elements.polymer-project.org/elements/carbon-route-converter?foo=bar&baz=qux`:

    {
      prefix: '',
      path: '/elements/carbon-route-converter'
    }

Example Usage:

    <carbon-location route="{{route}}"></carbon-location>
    <carbon-route route="{{route}}" pattern="/:page" data="{{data}}"></carbon-route>

As you can see above, the `carbon-location` element produces a `route` and that
property is then bound into the `carbon-route` element. The bindings are two-
directional, so when changes to the `route` object occur within `carbon-route`,
they automatically reflect back to the global location.

A `carbon-location` can be configured to use the hash part of a URL as the
canonical source for path information.

Example:

    <carbon-location route="{{route}}" use-hash-as-path></carbon-location>

@element carbon-location
@demo demo/index.html
-->

<dom-module id="carbon-location">
  <template>
    <iron-location
        path="{{path}}"
        query="{{__paramsString}}"
        url-space-regex={{urlSpaceRegex}}>
    </iron-location>
  </template>
  <script>
    'use strict';

    Polymer({
      is: 'carbon-location',

      behaviors: [Polymer.CarbonRouteConverterBehavior],
      properties: {
        /**
         * A model representing the deserialized path through the route tree, as
         * well as the current queryParams.
         */
        route: {
          type: Object,
          notify: true
        },

        /**
         * A regexp that defines the set of URLs that should be considered part
         * of this web app.
         *
         * Clicking on a link that matches this regex won't result in a full page
         * navigation, but will instead just update the URL state in place.
         *
         * This regexp is given everything after the origin in an absolute
         * URL. So to match just URLs that start with /search/ do:
         *     url-space-regex="^/search/"
         *
         * @type {string|RegExp}
         */
        urlSpaceRegex: {
          type: String,
          notify: true
        },

        __paramsString: {
          observer: '__paramsStringChanged',
        }
      },
      observers: [
        '__queryParamsChanged(queryParams.*)'
      ],

      __paramsStringChanged: function() {
        this._dontReact = true;
        this.queryParams = this._decodeParams(this.__paramsString);
        this._dontReact = false;
      },
      __queryParamsChanged: function() {
        if (this._dontReact) {
          return;
        }
        this.__paramsString = this._encodeParams(this.queryParams);
      },
      _encodeParams: function(params) {
        var encodedParams = [];
        for (var key in params) {
          var value = params[key];
          if (value === '') {
            encodedParams.push(encodeURIComponent(key));
          } else if (value) {
            encodedParams.push(
                encodeURIComponent(key) +
                '=' +
                encodeURIComponent(value.toString())
            );
          }
        }
        return encodedParams.join('&');
      },
      _decodeParams: function(paramString) {
        var params = {};
        var paramList = (paramString || '').split('&');
        for (var i = 0; i < paramList.length; i++) {
          var param = paramList[i].split('=');
          if (param[0]) {
            params[decodeURIComponent(param[0])] =
                decodeURIComponent(param[1] || '');
          }
        }
        return params;
      }
    });
  </script>
</dom-module>
